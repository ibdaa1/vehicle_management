<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>إدارة صلاحيات الأدوار</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600&display=swap" rel="stylesheet">
<style>body{font-family:"Tajawal",sans-serif;padding:18px;background:#f6f7f9;color:#0d2b16} .card{background:#fff;padding:16px;border-radius:10px;border:1px solid #e6e9eb} table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #eee;text-align:right} th{background:#fafafa}</style>
</head>
<body>
  <div class="card">
    <h2>صلاحيات الأدوار</h2>
    <div id="msg">جاري التحميل…</div>
    <table id="rolesTable"><thead><tr><th>اسم</th><th>انشاء</th><th>تعديل</th><th>حذف</th><th>تفاصيل</th><th>حفظ</th></tr></thead><tbody></tbody></table>
  </div>
<script>
async function loadRoles(){
  const res = await fetch('/vehicle_management/api/permissions/roles/list.php', { credentials:'same-origin' });
  const j = await res.json();
  const tbody = document.querySelector('#rolesTable tbody');
  if (!j.success) { document.getElementById('msg').textContent = j.message || 'خطأ'; return; }
  document.getElementById('msg').textContent = '';
  tbody.innerHTML = '';
  j.roles.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name_en} / ${r.name_ar}</td>
      <td style="text-align:center"><input type="checkbox" class="c_create" data-id="${r.id}" ${r.can_create==1?'checked':''}></td>
      <td style="text-align:center"><input type="checkbox" class="c_edit" data-id="${r.id}" ${r.can_edit==1?'checked':''}></td>
      <td style="text-align:center"><input type="checkbox" class="c_delete" data-id="${r.id}" ${r.can_delete==1?'checked':''}></td>
      <td><input type="text" class="desc" data-id="${r.id}" value="${r.description || ''}" style="width:100%"></td>
      <td><button class="saveBtn" data-id="${r.id}">حفظ</button></td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll('.saveBtn').forEach(b=>{
    b.onclick = async ()=> {
      const id = b.getAttribute('data-id');
      const can_create = document.querySelector('.c_create[data-id="'+id+'"]').checked ? 1 : 0;
      const can_edit = document.querySelector('.c_edit[data-id="'+id+'"]').checked ? 1 : 0;
      const can_delete = document.querySelector('.c_delete[data-id="'+id+'"]').checked ? 1 : 0;
      const desc = document.querySelector('.desc[data-id="'+id+'"]').value || '';
      const fd = new FormData();
      fd.append('role_id', id);
      fd.append('can_create', can_create);
      fd.append('can_edit', can_edit);
      fd.append('can_delete', can_delete);
      fd.append('description', desc);
      const res = await fetch('/vehicle_management/api/permissions/roles/update.php', { method:'POST', credentials:'same-origin', body: fd });
      const j = await res.json();
      if (j.success) alert('Saved'); else alert(j.message || 'Error');
      loadRoles();
    };
  });
}
loadRoles();
</script>
</body>
</html>